# Server Integration Requirements

## Responsibilities at a glance

- Accept queued client events (feedback, manual reports, telemetry) from the mobile outbox whenever connectivity is available.
- Publish the model catalog so mobile clients can install and activate updated `.tflite` builds.
- Host optional configuration/health endpoints that help support and diagnostics workflows.
- Complement—but never replace—the fully offline model inference path that ships with the mobile app.

## Runtime environment & auth

| Concern | Expectation |
| --- | --- |
| Outbox endpoint | Configure `EXPO_PUBLIC_FEEDBACK_ENDPOINT` (HTTPS) for queued events; telemetry, feedback, and reports share this host. |
| Model catalog URL | Expose `EXPO_PUBLIC_MODEL_CATALOG_URL` (HTTPS) where clients fetch the latest `.tflite` metadata. |
| Authentication | Use a static bearer token or signed JWT per device. Include it in the `Authorization` header for all endpoints. Token procurement flow is TBD. |
| Rate limits | Minimum 600 queued event posts/minute per tenant. Provide `429` with `Retry-After` when exceeded. |
| Time sync | All timestamps are ISO-8601 UTC. Server clocks must be NTP-synced to avoid cache duplication. |
| Payload size | Accept request bodies up to 256 KB. Reject larger payloads with HTTP `413`. |

## Unified outbox intake

The mobile app buffers feedback, telemetry, and manual reports in a single outbox. When network connectivity is available it posts each entry to one configurable endpoint.

### Endpoint

- `POST {EXPO_PUBLIC_FEEDBACK_ENDPOINT}`

### Envelope format

```json
{
  "id": "feedback@sms-8ce1",
  "channel": "feedback",
  "payload": { "recordId": "sms-8ce1", "status": "confirmed" },
  "createdAt": "2025-10-17T12:10:00Z"
}
```

| Field | Type | Notes |
| --- | --- | --- |
| `id` | string | Stable identifier; clients reuse the same `id` when replacing entries. |
| `channel` | string | One of `feedback`, `telemetry`, `report`. Use this to route downstream processing. |
| `payload` | object | Channel-specific JSON payload. See sections below. |
| `createdAt` | string | ISO-8601 timestamp assigned on device. |

### Feedback channel

Payload mirrors detection feedback collected inside the app.

```json
{
  "recordId": "sms-8ce1",
  "status": "false_positive",
  "submittedAt": "2025-10-17T11:41:26Z",
  "source": "historical",
  "channel": "sms",
  "score": 0.72
}
```

| Field | Type | Required | Description |
| --- | --- | --- | --- |
| `recordId` | string | ✅ | Detection identifier generated by the on-device inference module. |
| `status` | `"confirmed" \| "false_positive"` | ✅ | Whether the user agreed with the model decision. |
| `submittedAt` | string | ✅ | UTC timestamp when feedback was captured. |
| `source` | `"historical" \| "simulated"` | ✅ | Origin of the detection in the client history. |
| `channel` | `"sms" \| "whatsapp" \| "email"` | ✅ | Communication channel. |
| `score` | number | ✅ | Model score shown to the user (two decimal precision). |

### Telemetry channel

Buffers downstream analytics events.

```json
{
  "name": "dashboard.shield_toggled",
  "payload": { "paused": false },
  "timestamp": "2025-10-17T12:09:10Z"
}
```

| Field | Type | Required | Notes |
| --- | --- | --- | --- |
| `name` | string | ✅ | Must be one of the event names defined in `lib/services/telemetry.ts`. |
| `payload` | object | ✅ | Typed payload for the event; the server should validate by event name. |
| `timestamp` | string | ✅ | When the event occurred on device. |

### Report channel

Carries manual phishing reports submitted by the user.

```json
{
  "reportId": "rep-20251017-1205",
  "message": {
    "sender": "+2348100000000",
    "channel": "sms",
    "body": "Claim your prize",
    "receivedAt": "2025-10-17T10:55:00Z"
  },
  "category": "phishing",
  "comment": "Same scam as yesterday",
  "createdAt": "2025-10-17T12:05:41Z",
  "attachments": []
}
```

| Field | Type | Required | Description |
| --- | --- | --- | --- |
| `reportId` | string | ✅ | Stable identifier generated by the client. Use it for idempotency. |
| `message.sender` | string | ✅ | Address or number reported. |
| `message.channel` | `"sms" \| "whatsapp" \| "email"` | ✅ | Channel where the message was seen. |
| `message.body` | string | ✅ | Raw message content. |
| `message.receivedAt` | string | ➖ | Optional timestamp of the original message. |
| `category` | `"phishing" \| "suspicious" \| "false_positive" \| "other"` | ✅ | User-selected classification. |
| `comment` | string | ➖ | Optional free-form notes from the reporter. |
| `createdAt` | string | ✅ | When the report was filed. |
| `attachments` | string[] | ➖ | Reserved for future screenshot uploads (URLs or blob handles). |

### Processing contract

- Respond with `202 Accepted` when the payload is queued successfully (preferred) or `200 OK` for synchronous ingestion.
- Respond with `409 Conflict` when a duplicate `id` arrives and no changes are needed. Include the canonical representation in the response.
- Respond with `400 Bad Request` when validation fails. Provide a machine-readable `{ "error": "invalid_payload", "field": "status" }` response to help debugging.
- After successful acceptance, the mobile client deletes the entry locally.

## Model registry API

The model manager fetches metadata and binaries for downloadable models.

### Catalog endpoint

- `GET /models/catalog.json`

Each catalog entry must match the shape below:

```json
{
  "version": "v0.3.0",
  "releasedAt": "2025-10-06T07:45:00Z",
  "sizeMB": 18.5,
  "checksum": "sha256-f32c9e12",
  "changelog": ["Introduced WhatsApp embeddings"],
  "downloadUrl": "https://download.afrihackbox.dev/models/v0.3.0/phishing-detector.tflite"
}
```

Requirements:

- Return HTTP `200` with an array sorted by `releasedAt` descending.
- Ensure the catalog is reachable within 8 seconds; otherwise the client falls back to a bundled dummy catalog.
- Sign the catalog or serve over HTTPS to prevent tampering.

### Binary downloads

- Provide direct HTTPS URLs (`downloadUrl`) for each model artifact.
- Support HTTP range requests so clients can resume interrupted downloads.
- Recommend max file size of 25 MB to stay within typical mobile bandwidth.

## Diagnostics & support endpoints

To aid troubleshooting, expose a lightweight endpoint that echoes server status.

- `GET /v1/health` → `{ "status": "ok", "uptime": 1234 }`
- `GET /v1/config` → returns feature flags, minimum app version, and maintenance windows.

These endpoints are optional but strongly recommended for automated monitoring and client feature gating.

## Security checklist

- Enforce HTTPS with modern TLS (1.2+).
- Validate every payload against JSON schemas to avoid malformed data.
- Sanitize telemetry and report content before storing or indexing.
- Implement audit logging for all write operations, keyed by device identifier or auth token.

## Open questions

1. How will devices obtain and refresh the authentication token used for server requests?
2. Do we require per-tenant routing or multi-tenant isolation for queued outbox data?
3. Should manual reports support rich media uploads at launch, or defer to a later milestone?
4. What retention policy applies to telemetry events and user feedback stored on the server?
